% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/bootstrap.R
\name{boot_pred_block}
\alias{boot_pred_block}
\title{Block Bootstrap for Functional Quantile GAM}
\usage{
boot_pred_block(
  d,
  B,
  seed,
  tau,
  X20,
  X80,
  model,
  multicore = TRUE,
  ncores = 3,
  verbose = TRUE
)
}
\arguments{
\item{d}{A data.frame used to fit the model. Must contain columns:
\describe{
\item{id}{Subject identifier (factor). Observations from the same subject
must share the same id.}
\item{y}{Response variable (numeric)}
\item{time}{Longitudinal time stamps (integer or numeric)}
\item{Xobs}{Matrix of functional covariate observations (n x S matrix,
where S is the number of functional grid points)}
\item{sMat}{Matrix of functional domain coordinates (n x S matrix)}
\item{tMat}{Matrix of longitudinal time coordinates (n x S matrix)}
}}

\item{B}{Integer. Number of bootstrap iterations. Battagliola et al. (2024)
use B = 100 in their application.}

\item{seed}{Integer. Random seed for reproducibility.}

\item{tau}{Numeric. Quantile level in (0,1). Should match the quantile
level used in the fitted model.}

\item{X20}{Numeric vector of length S. Point-wise lower reference curve
(e.g., 20\\% quantile of functional covariates).}

\item{X80}{Numeric vector of length S. Point-wise upper reference curve
(e.g., 80\\% quantile of functional covariates).}

\item{model}{A fitted \code{qgam} model object.}

\item{multicore}{Logical. If \code{TRUE}, uses parallel computation in
\code{qgam}. Default is \code{TRUE}.}

\item{ncores}{Integer. Number of cores for parallel computation.
Default is 3.}

\item{verbose}{Logical. If \code{TRUE}, prints progress messages.
Default is \code{TRUE}.}
}
\value{
A list of class \code{"fqgam_boot"} with components:
\describe{
\item{pred20}{Matrix (B x maxT) of predicted quantiles at each
longitudinal time for X20}
\item{pred80}{Matrix (B x maxT) of predicted quantiles at each
longitudinal time for X80}
\item{predDiff}{Matrix (B x maxT) of differences \eqn{\hat{Q}_{20}^\tau(t) - \hat{Q}_{80}^\tau(t)}}
\item{seed}{The random seed used}
\item{d}{The input data.frame}
\item{tau}{The quantile level}
\item{running_time}{Vector of execution times (in seconds) for each iteration}
\item{bootstrap_type}{"block"}
}
}
\description{
Performs block bootstrap inference for functional quantile regression models
fitted with \code{\link[qgam]{qgam}}. The bootstrap resamples complete subject
trajectories with replacement, preserving the longitudinal dependence structure.
}
\details{
\strong{Purpose:}
Block bootstrap is primarily used for variance estimation and construction
of standard errors. As noted in Battagliola et al. (2024), model-based standard
errors from \code{qgam} may underestimate the true sampling variation due to
penalization of random effects.

\strong{Algorithm:}
For each bootstrap iteration b = 1, ..., B:
(1) Create a bootstrap dataset by sampling N subjects with replacement.
(2) Fit the quantile regression model to the bootstrap data.
(3) Compute predictions at reference curves X20 and X80 for each time point.
(4) Store the difference in predictions.

The bootstrap standard error is: sd_boot = sd(theta_1, ..., theta_B).

\strong{Predictions:}
For a reference functional covariate X(s) at longitudinal time t,
the predicted quantile (excluding random effects) represents the
tau-quantile for a typical subject with u_i = 0.

\strong{Important Note on Bias:}
Block bootstrap estimates are centered around the original estimate, so this
method is not suitable for bias adjustment. For bias correction, use
\code{\link{boot_pred_wild}} instead.
}
\examples{
\dontrun{
library(refund)
library(qgam)

# Prepare DTI data
data(DTI)
myData <- DTI[complete.cases(DTI$cca), ]
myData <- subset(myData, Nscans > 1)

# Create data.frame for qgam
N <- nrow(myData)
S <- ncol(myData$cca)
sVec <- seq(0, 1, length = S)

myDataFit <- data.frame(
  y = myData$pasat,
  id = factor(myData$ID),
  time = myData$visit.time
)
myDataFit$Xobs <- myData$cca
myDataFit$sMat <- matrix(sVec, N, S, byrow = TRUE)
myDataFit$tMat <- matrix(myData$visit.time, N, S, byrow = FALSE)

# Fit model at tau = 0.1
tau <- 0.1
formula <- y ~ s(time, bs = "cr", k = 10) + 
              te(sMat, tMat, by = Xobs, bs = c("cr", "cr"), k = c(10, 10)) + 
              s(id, bs = "re")
fit <- qgam(formula, qu = tau, data = myDataFit)

# Get reference curves (20\% and 80\% pointwise quantiles)
cca20 <- apply(myData$cca, 2, quantile, probs = 0.2)
cca80 <- apply(myData$cca, 2, quantile, probs = 0.8)

# Run block bootstrap for variance estimation
bb <- boot_pred_block(myDataFit, B = 100, seed = 1234, tau = tau,
                      X20 = cca20, X80 = cca80, model = fit)

# Compute bootstrap standard errors
sd_block <- apply(bb$predDiff, 2, sd)
}

}
\references{
Battagliola, M.L., Sorensen, H., Tolver, A., & Staicu, A.-M. (2024).
Quantile regression for longitudinal functional data with application to
feed intake of lactating sows. Journal of Agricultural, Biological, and
Environmental Statistics, 30(1), 211-230.

Galvao, A., & Montes-Rojas, G. (2015). On bootstrap inference for quantile
regression panel data: A Monte Carlo study. Econometrics, 3(3), 654-666.
}
\seealso{
\code{\link{boot_pred_wild}} for wild bootstrap (bias adjustment),
\code{\link{boot_ci}} for computing confidence intervals,
\code{\link[qgam]{qgam}} for model fitting
}
